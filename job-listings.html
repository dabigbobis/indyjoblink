<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Listings - Independence High School Career Center</title>
  <!-- Include the authentication redirect script first -->
  <script src="auth-redirect.js"></script>
  <link rel="stylesheet" href="home-styles.css">
  <style>
    /* Tab navigation styles */
    .listings-tabs {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
    }

    .listings-tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .listings-tab.active {
      border-bottom: 3px solid var(--secondary);
      color: var(--secondary);
    }

    .listings-tab:hover {
      background-color: rgba(0,0,0,0.05);
    }

    .listings-section {
      display: none;
    }

    .listings-section.active {
      display: block;
    }

    .no-listings {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .job-card {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }

    @media (min-width: 768px) {
      .job-card {
        flex-direction: row;
        justify-content: space-between;
      }

      .job-actions {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
      }
    }
  </style>
</head>

<body>
<!-- Header -->
<header>
  <div class="container">
    <nav>
      <div class="logo">
        <h1>Indy JobLink</h1>
      </div>
      <ul>
        <li><a href="#" id="home-link">Home</a></li>
        <li><a href="#" class="active">Job Listings</a></li>
        <!-- Dynamic logout link will be added by JavaScript -->
      </ul>
    </nav>
  </div>
</header>

<main>
  <div class="container">
    <h2 class="section-title">Job Listings</h2>

    <!-- Tab Navigation -->
    <div class="listings-tabs">
      <button class="listings-tab active" onclick="showListingsTab('current-listings')">Current Listings</button>
      <button class="listings-tab" onclick="showListingsTab('applied-listings')">Applied Listings</button>
    </div>

    <!-- Current Listings Section -->
    <div id="current-listings" class="listings-section active">
      <div class="card">
        <div class="search-bar">
          <input type="text" id="search-listings" placeholder="Search job listings...">
          <button class="btn" onclick="searchListings()">Search</button>
        </div>

        <div id="current-listings-content">
          <!-- This will be populated with job listings from JavaScript -->
          <div class="no-listings" id="no-current-listings">
            <p>No job listings are currently available.</p>
            <p>Check back soon as employers add new opportunities!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Applied Listings Section -->
    <div id="applied-listings" class="listings-section">
      <div class="card">
        <div id="applied-listings-content">
          <!-- This will be populated with applied job listings from JavaScript -->
          <div class="no-listings" id="no-applied-listings">
            <p>You haven't applied to any jobs yet.</p>
            <p>Browse the Current Listings tab to find opportunities!</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Application Success Modal -->
<div id="applicationSuccessModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div class="modal-content" style="background-color: white; padding: 2rem; border-radius: 8px; max-width: 500px; text-align: center;">
    <h3>Application Submitted!</h3>
    <p>Your application has been successfully sent to the employer.</p>
    <p>You can view the status in the "Applied Listings" tab.</p>
    <button class="btn btn-primary" onclick="closeApplicationModal()">Close</button>
  </div>
</div>

<!-- Footer -->
<footer>
  <div class="container">
    <div class="footer-content">
      <div>
        <p>&copy; 2025 Independence High School Career Center</p>
      </div>
      <div class="footer-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
        <a href="#">Contact Guidance Department</a>
      </div>
    </div>
  </div>
</footer>

<script>
  // Check authentication
  document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in and is a student
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!currentUser) {
      window.location.href = 'login.html';
      return;
    }

    if (currentUser.type !== 'student') {
      window.location.href = 'home.html';
      return;
    }

    // Setup navigation
    setupNavigation(currentUser);

    // Load job listings data
    loadJobListings();

    // Load applied listings
    loadAppliedListings(currentUser);

    // Home link redirect
    document.getElementById('home-link').addEventListener('click', function(e) {
      e.preventDefault();

      // Check user type and redirect accordingly
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
      if (currentUser) {
        if (currentUser.type === 'student') {
          window.location.href = 'student-home.html';
        } else if (currentUser.type === 'employer') {
          window.location.href = 'employer-home.html';
        } else if (currentUser.type === 'admin') {
          window.location.href = 'admin-pending.html';
        }
      } else {
        // Default fallback - should not happen due to auth checks
        window.location.href = 'login.html';
      }
    });
  });

  // Setup navigation based on user type
  function setupNavigation(currentUser) {
    const navContainer = document.querySelector('nav ul');
    if (!navContainer) return;

    // Check if the logout link already exists
    const existingLogoutLink = document.getElementById('logout-link');

    if (currentUser && !existingLogoutLink) {
      // Create the welcome text element
      const welcomeItem = document.createElement('li');
      welcomeItem.className = 'welcome-text';
      welcomeItem.textContent = `Welcome, ${currentUser.name || 'Student'}`;

      // Create logout link
      const logoutItem = document.createElement('li');
      const logoutLink = document.createElement('a');
      logoutLink.href = '#';
      logoutLink.textContent = 'Logout';
      logoutLink.id = 'logout-link';
      logoutLink.addEventListener('click', logout);
      logoutItem.appendChild(logoutLink);

      // Add to navigation
      navContainer.appendChild(welcomeItem);
      navContainer.appendChild(logoutItem);
    }
  }

  // Show tab content
  function showListingsTab(tabId) {
    // Update tab buttons
    document.querySelectorAll('.listings-tab').forEach(tab => {
      tab.classList.remove('active');
    });

    // Find the tab button
    const activeTabButton = document.querySelector(`.listings-tab[onclick="showListingsTab('${tabId}')"]`);
    if (activeTabButton) {
      activeTabButton.classList.add('active');
    }

    // Hide all sections
    document.querySelectorAll('.listings-section').forEach(section => {
      section.classList.remove('active');
    });

    // Show active section
    const activeSection = document.getElementById(tabId);
    if (activeSection) {
      activeSection.classList.add('active');
    }
  }

  // Load job listings
  function loadJobListings() {
    // Get the approved job listings from localStorage
    const approvedJobs = JSON.parse(localStorage.getItem('approvedJobs')) || [];
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

    // Filter out jobs that the student has already applied to
    const appliedJobIds = (currentUser.applications || []).map(app => app.jobId);
    const availableJobs = approvedJobs.filter(job => !appliedJobIds.includes(job.id));

    // Check if we have listings
    if (availableJobs && availableJobs.length > 0) {
      document.getElementById('no-current-listings').style.display = 'none';
      const listingsContainer = document.getElementById('current-listings-content');
      let listingsHTML = '';

      // Create HTML for each listing
      availableJobs.forEach(job => {
        listingsHTML += `
          <div class="job-card card" id="job-${job.id}">
            <div class="job-info">
              <h3>${job.title}</h3>
              <div class="job-meta">
                <p><strong>Company:</strong> ${job.company}</p>
                <p><strong>Type:</strong> ${job.type}</p>
                <p><strong>Salary:</strong> ${job.salary}</p>
                <p><strong>Location:</strong> ${job.location || 'Not specified'}</p>
                <p>${job.description}</p>
                ${job.requirements ? `<p><strong>Requirements:</strong> ${job.requirements}</p>` : ''}
              </div>
            </div>
            <div class="job-actions">
              <button class="btn btn-primary" onclick="applyForJob('${job.id}')">Apply Now</button>
            </div>
          </div>
        `;
      });

      listingsContainer.innerHTML = listingsHTML;
    }
  }

  // Load applied listings
  function loadAppliedListings(currentUser) {
    // Check if user has any applications
    if (currentUser.applications && currentUser.applications.length > 0) {
      document.getElementById('no-applied-listings').style.display = 'none';
      const appliedContainer = document.getElementById('applied-listings-content');
      let appliedHTML = '';

      // Create HTML for each application
      currentUser.applications.forEach(application => {
        appliedHTML += `
          <div class="job-card card">
            <div class="job-info">
              <h3>${application.jobTitle || 'Unnamed Position'}</h3>
              <div class="job-meta">
                <p><strong>Company:</strong> ${application.company || 'Unknown'}</p>
                <p><strong>Status:</strong> <span class="status-${application.status?.toLowerCase() || 'pending'}">${application.status || 'Pending'}</span></p>
                <p><strong>Applied:</strong> ${new Date(application.dateApplied).toLocaleDateString()}</p>
              </div>
            </div>
          </div>
        `;
      });

      appliedContainer.innerHTML = appliedHTML;
    }
  }

  // Apply for a job
  function applyForJob(jobId) {
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!currentUser || currentUser.type !== 'student') {
      alert('Please log in as a student to apply for jobs.');
      return;
    }

    // Get the job details
    const approvedJobs = JSON.parse(localStorage.getItem('approvedJobs')) || [];
    const job = approvedJobs.find(j => j.id === jobId);

    if (!job) {
      alert('Job listing not found.');
      return;
    }

    // Create application record
    const application = {
      id: 'app_' + Date.now(),
      jobId: job.id,
      jobTitle: job.title,
      company: job.company,
      employerId: job.employerId,
      studentId: currentUser.studentId,
      studentName: currentUser.name,
      studentEmail: currentUser.email,
      studentGrade: currentUser.grade,
      status: 'Pending',
      dateApplied: new Date().toISOString()
    };

    // Add to applications in localStorage
    const applications = JSON.parse(localStorage.getItem('applications')) || [];
    applications.push(application);
    localStorage.setItem('applications', JSON.stringify(applications));

    // Add to student's applications
    if (!currentUser.applications) {
      currentUser.applications = [];
    }
    currentUser.applications.push({
      id: application.id,
      jobId: job.id,
      jobTitle: job.title,
      company: job.company,
      status: 'Pending',
      dateApplied: application.dateApplied
    });
    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

    // Update users in localStorage
    const users = JSON.parse(localStorage.getItem('users')) || { students: [], employers: [], admins: [] };
    const studentIndex = users.students.findIndex(s => s.studentId === currentUser.studentId);
    if (studentIndex !== -1) {
      users.students[studentIndex].applications = currentUser.applications;
      localStorage.setItem('users', JSON.stringify(users));
    }

    // Remove job from current listings
    const jobElement = document.getElementById(`job-${jobId}`);
    if (jobElement) {
      jobElement.remove();
    }

    // Show success message
    showApplicationSuccess();

    // Refresh applied listings
    loadAppliedListings(currentUser);
  }

  // Show application success modal
  function showApplicationSuccess() {
    const modal = document.getElementById('applicationSuccessModal');
    modal.style.display = 'flex';
  }

  // Close application modal
  function closeApplicationModal() {
    document.getElementById('applicationSuccessModal').style.display = 'none';
  }

  // View application details
  function viewApplication(applicationId) {
    alert('Application details will be available in a future update.');
  }

  // Search job listings
  function searchListings() {
    const searchTerm = document.getElementById('search-listings').value.toLowerCase();
    const jobCards = document.querySelectorAll('.job-card');

    jobCards.forEach(card => {
      const jobTitle = card.querySelector('h3').textContent.toLowerCase();
      const jobInfo = card.querySelector('.job-meta').textContent.toLowerCase();

      if (jobTitle.includes(searchTerm) || jobInfo.includes(searchTerm)) {
        card.style.display = 'flex';
      } else {
        card.style.display = 'none';
      }
    });

    // Show/hide no listings message
    const visibleJobs = Array.from(jobCards).filter(card => card.style.display !== 'none');
    document.getElementById('no-current-listings').style.display =
            visibleJobs.length === 0 ? 'block' : 'none';
  }

  // Logout function
  function logout(e) {
    if (e) e.preventDefault();
    sessionStorage.removeItem('currentUser');
    window.location.href = 'login.html';
  }
</script>
</body>

</html>